<!-- Generated by ralph init -->
<!-- generator: ralph-init -->
<!-- safe_to_delete: true -->

# AGENTS.md - Project Configuration for AI Agents

This file contains critical operational details that AI agents should know when working on this project.

## Project-Specific Configuration

- **Package Manager**: Bun
- **Build Command**: `bun run build` (Vite for current React app)
- **Test Command**: `bun test` (Vitest)
- **Lint Command**: Configured via eslint.config.js
- **Project Root**: C:\Repository\CITUCourseBuilder
- **Current App Location**: course-scheduler-web/ (React 19 + Vite)
- **Target App Location**: course-scheduler-astro/ (Astro 5.x - to be created)

## Critical Operational Details

### Preserved Logic Files (DO NOT MODIFY LOGIC)

These files contain critical parsing and scheduling logic that MUST be preserved exactly:
- `course-scheduler-web/src/utils/parseSchedule.js` - Schedule string parsing (427 lines)
- `course-scheduler-web/src/utils/parseRawData.js` - Course data parsing (375 lines)
- `course-scheduler-web/src/utils/generateIcs.js` - ICS calendar generation (111 lines)
- `course-scheduler-web/src/utils/convertToRawData.js` - Raw data conversion (29 lines)
- Scheduling algorithms in App.jsx (~461 lines) - to be extracted to separate module

### Scheduling Algorithms (13 Functions)

**Core Utility Functions:**
- `loadFromLocalStorage(key, defaultValue)` - Load persisted state with validation (~72 lines)
- `getSectionTypeSuffix(sectionString)` - Extract AP3/AP4/AP5 from section string (~5 lines)

**Time & Conflict Detection:**
- `checkTimeOverlap(start1, end1, start2, end2)` - Check if two time ranges overlap (~6 lines)
- `isScheduleConflictFree(schedule, parseFn, overlapFn)` - Verify schedule has no conflicts (~31 lines)
- `getTimeOfDayBucket(time)` - Categorize time as morning/afternoon/evening (~7 lines)

**Constraint Validation:**
- `scoreScheduleByTimePreference(schedule, prefOrder)` - Score schedule by time preferences (~15 lines)
- `exceedsMaxUnits(schedule, maxUnits)` - Check if exceeds unit limit (~7 lines)
- `exceedsMaxGap(schedule, maxGapHours)` - Check if gaps exceed threshold (~30 lines)
- `countCampusDays(schedule)` - Count unique on-campus days (~16 lines)

**Schedule Generation:**
- `getAllSubsets(arr)` - Generate power set (~9 lines)
- `generateExhaustiveBestSchedule(...)` - Exhaustive search algorithm (~83 lines)
- `generateBestPartialSchedule_Heuristic(...)` - Heuristic-based generator (~121 lines)
- `generateBestPartialSchedule(...)` - Main partial schedule entry point (~64 lines)

**Critical Dependencies:**
- All schedule analysis functions depend on `parseSchedule` from utils
- `SMALL_N_THRESHOLD_PARTIAL = 12` - Threshold for switching from exhaustive to heuristic
- Score formula: `totalCourses * 100 + totalUnits` (higher is better)
- Time preference score: lower is better (based on preference order index)

### Code Style & Conventions
- Use TypeScript strict mode for all new code
- Prefer functional components in React
- No `any` types allowed
- JSDoc comments for public APIs
- Preserve ALL existing logic exactly when migrating

### Architecture Notes

**Current React Architecture (course-scheduler-web/):**
- Single root component (App.jsx) with 22 useState hooks
- Flat component hierarchy (max 1 level prop drilling)
- 13 localStorage keys for persistence
- 13 scheduling algorithms embedded in App.jsx (~461 lines)
- MUI components for UI elements
- react-toastify for notifications
- react-datepicker for time selection

**TypeScript Interfaces (docs/architecture/types/index.ts):**
- Core types: DayCode, TimeOfDayBucket, ScheduleSearchMode, GroupingMode
- Data types: TimeSlot, ParsedSchedule, Course, GroupedCourse, CoursesBySubject
- State types: FilterState, SchedulePreferences, AppState
- 25+ interfaces defined for migration

**State Categories:**
1. Core Data: allCourses, processedCourses, rawData
2. Theme: theme, themePalette
3. Filters: excludedDays, excludedTimeRanges, sectionTypes, statusFilter
4. Preferences: maxUnits, maxGapHours, preferredTimeOrder, searchMode
5. UI State: showTimetable, isGenerating, confirmDialog
6. Generated: generatedSchedules, currentScheduleIndex

**Component Dependencies:**
- App.jsx imports all child components directly
- TimeFilter uses react-datepicker
- CourseTable uses MUI Menu, MenuItem, IconButton, Tooltip
- TimetableView uses html-to-image, jspdf for exports
- ConfirmDialog uses MUI Dialog components

### Environment Setup
- Node.js 18+ required
- Bun as package manager
- No environment variables required for local development
- GitHub Pages deployment with /CITUCourseBuilder/ base path

## Common Gotchas & Lessons Learned

1. **Schedule parsing is complex**: The parseSchedule.js handles TBA schedules, multi-slot schedules, hybrid schedules (F2F+Online), and comma-separated day codes. Any modification risks breaking compatibility with WITS/AIMS data formats.

2. **Conflict detection is critical**: The `checkTimeOverlap` and `isScheduleConflictFree` functions are used extensively. Changes here could cause valid schedules to be rejected or conflicting schedules to be accepted.

3. **localStorage keys are namespaced**: All keys use `courseBuilder_` prefix. The `loadFromLocalStorage` function includes validation and defaults for each key type.

4. **Theme system uses CSS custom properties**: The App.css defines 100+ CSS variables for theming. Light/dark modes plus 3 palettes (original, comfort, space) create 6 theme combinations.

5. **Schedule generation has 3 modes**:
   - `partial` (default): Heuristic-based, maximizes subjects even if not all fit
   - `exhaustive`: Tries all combinations, fails if can't fit all subjects
   - `fast`: Random sampling, may miss optimal schedules

6. **Course identity is compound**: Courses are identified by `{id, subject, section}` tuple, not just `id`.

## Protected Files

The following files are protected by the Ralph write-guardrail plugin and should not be directly modified by AI:

- `prd.json` - PRD plan file (update via Ralph workflow)
- `progress.txt` - Progress tracking (append via Ralph workflow)
- `.ralph-prompt.md` - Prompt template
- `AGENTS.md` - This file

## References

- Project Documentation: docs/architecture/ (state analysis, component graphs, algorithm docs)
- Architecture Analysis: docs/architecture/APP_STATE_ANALYSIS.md
- Component Graphs: docs/architecture/COMPONENT_DEPENDENCY_GRAPH.md
- Algorithm Documentation: docs/architecture/SCHEDULING_ALGORITHMS.md
- TypeScript Interfaces: docs/architecture/types/index.ts
- Usage Guide: https://github.com/MasuRii/CITUCourseBuilder/blob/main/UsageGuide.md
