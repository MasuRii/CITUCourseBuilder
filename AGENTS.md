<!-- Generated by ralph init -->
<!-- generator: ralph-init -->
<!-- safe_to_delete: true -->

# AGENTS.md - Project Configuration for AI Agents

This file contains critical operational details that AI agents should know when working on this project.

## Project-Specific Configuration

- **Package Manager**: Bun
- **Build Command**: `bun run build` (Vite for current React app)
- **Test Command**: `bun test` (Vitest)
- **Lint Command**: Configured via eslint.config.js at monorepo root
- **Project Root**: C:\Repository\CITUCourseBuilder
- **Current App Location**: course-scheduler-web/ (React 19 + Vite)
- **Target App Location**: course-scheduler-astro/ (Astro 5.x - initialized)

## Critical Operational Details

### Preserved Logic Files (DO NOT MODIFY LOGIC)

These files contain critical parsing and scheduling logic that MUST be preserved exactly:

- `course-scheduler-web/src/utils/parseSchedule.js` - Schedule string parsing (427 lines)
- `course-scheduler-web/src/utils/parseRawData.js` - Course data parsing (375 lines)
- `course-scheduler-web/src/utils/generateIcs.js` - ICS calendar generation (111 lines)
- `course-scheduler-web/src/utils/convertToRawData.js` - Raw data conversion (29 lines)
- Scheduling algorithms in App.jsx (~461 lines) - to be extracted to separate module

### Scheduling Algorithms (13 Functions)

**Core Utility Functions:**

- `loadFromLocalStorage(key, defaultValue)` - Load persisted state with validation (~72 lines)
- `getSectionTypeSuffix(sectionString)` - Extract AP3/AP4/AP5 from section string (~5 lines)

**Time & Conflict Detection:**

- `checkTimeOverlap(start1, end1, start2, end2)` - Check if two time ranges overlap (~6 lines)
- `isScheduleConflictFree(schedule, parseFn, overlapFn)` - Verify schedule has no conflicts (~31 lines)
- `getTimeOfDayBucket(time)` - Categorize time as morning/afternoon/evening (~7 lines)

**Constraint Validation:**

- `scoreScheduleByTimePreference(schedule, prefOrder)` - Score schedule by time preferences (~15 lines)
- `exceedsMaxUnits(schedule, maxUnits)` - Check if exceeds unit limit (~7 lines)
- `exceedsMaxGap(schedule, maxGapHours)` - Check if gaps exceed threshold (~30 lines)
- `countCampusDays(schedule)` - Count unique on-campus days (~16 lines)

**Schedule Generation:**

- `getAllSubsets(arr)` - Generate power set (~9 lines)
- `generateExhaustiveBestSchedule(...)` - Exhaustive search algorithm (~83 lines)
- `generateBestPartialSchedule_Heuristic(...)` - Heuristic-based generator (~121 lines)
- `generateBestPartialSchedule(...)` - Main partial schedule entry point (~64 lines)

**Critical Dependencies:**

- All schedule analysis functions depend on `parseSchedule` from utils
- `SMALL_N_THRESHOLD_PARTIAL = 12` - Threshold for switching from exhaustive to heuristic
- Score formula: `totalCourses * 100 + totalUnits` (higher is better)
- Time preference score: lower is better (based on preference order index)

### Code Style & Conventions

- Use TypeScript strict mode for all new code
- Prefer functional components in React
- No `any` types allowed
- JSDoc comments for public APIs
- Preserve ALL existing logic exactly when migrating

### Architecture Notes

**Current React Architecture (course-scheduler-web/):**

- Single root component (App.jsx) with 22 useState hooks
- Flat component hierarchy (max 1 level prop drilling)
- 13 localStorage keys for persistence
- 13 scheduling algorithms embedded in App.jsx (~461 lines)
- MUI components for UI elements
- react-toastify for notifications
- react-datepicker for time selection

**TypeScript Interfaces (docs/architecture/types/index.ts):**

- Core types: DayCode, TimeOfDayBucket, ScheduleSearchMode, GroupingMode
- Data types: TimeSlot, ParsedSchedule, Course, GroupedCourse, CoursesBySubject
- State types: FilterState, SchedulePreferences, AppState
- 25+ interfaces defined for migration

**State Categories:**

1. Core Data: allCourses, processedCourses, rawData
2. Theme: theme, themePalette
3. Filters: excludedDays, excludedTimeRanges, sectionTypes, statusFilter
4. Preferences: maxUnits, maxGapHours, preferredTimeOrder, searchMode
5. UI State: showTimetable, isGenerating, confirmDialog
6. Generated: generatedSchedules, currentScheduleIndex

**Component Dependencies:**

- App.jsx imports all child components directly
- TimeFilter uses react-datepicker
- CourseTable uses MUI Menu, MenuItem, IconButton, Tooltip
- TimetableView uses html-to-image, jspdf for exports
- ConfirmDialog uses MUI Dialog components

### Environment Setup

- Node.js 18+ required
- Bun as package manager
- No environment variables required for local development
- GitHub Pages deployment with /CITUCourseBuilder/ base path

## Common Gotchas & Lessons Learned

1. **Schedule parsing is complex**: The parseSchedule.js handles TBA schedules, multi-slot schedules, hybrid schedules (F2F+Online), and comma-separated day codes. Any modification risks breaking compatibility with WITS/AIMS data formats.

2. **Conflict detection is critical**: The `checkTimeOverlap` and `isScheduleConflictFree` functions are used extensively. Changes here could cause valid schedules to be rejected or conflicting schedules to be accepted.

3. **localStorage keys are namespaced**: All keys use `courseBuilder_` prefix. The `loadFromLocalStorage` function includes validation and defaults for each key type.

4. **Theme system uses CSS custom properties**: The App.css defines 107 CSS variables for theming. Light/dark modes plus 3 palettes (original, comfort, space) create 6 theme combinations. Theme switching uses `data-theme` and `data-palette` attributes on `document.documentElement`. See docs/architecture/CSS_ARCHITECTURE.md for complete inventory.

5. **CSS specificity gotchas**: The CSS uses `!important` in 8 places (conflict highlighting, group header rows). These override theme-specific styles and must be handled carefully in Tailwind migration.

6. **Responsive breakpoints**: CSS uses 992px, 768px, 480px breakpoints. The 768px breakpoint transforms tables to card-based layout (requires special handling in migration).

7. **Toastify CSS overrides**: 16 CSS custom properties control react-toastify styling. These map to theme colors and must be preserved or replaced with custom toast component.

8. **Schedule generation has 3 modes**:
   - `partial` (default): Heuristic-based, maximizes subjects even if not all fit
   - `exhaustive`: Tries all combinations, fails if can't fit all subjects
   - `fast`: Random sampling, may miss optimal schedules

9. **Course identity is compound**: Courses are identified by `{id, subject, section}` tuple, not just `id`.

10. **Test coverage baseline established**: Current coverage is 81.25% line coverage, 94.32% function coverage. Critical gaps exist in scheduling algorithms (0% coverage) and export functions (generateIcs.js, convertToRawData.js - 0% coverage). See docs/architecture/TEST_COVERAGE_BASELINE.md for detailed analysis.

11. **Untested critical paths**:
    - Scheduling algorithms (~461 lines in App.jsx) - must add tests before migration
    - ICS calendar generation (generateIcs.js, 111 lines)
    - Raw data export (convertToRawData.js, 29 lines)
    - Edge cases in parseSchedule.js (TBA schedules, multi-slot parsing)
    - Edge cases in parseRawData.js (malformed HTML, invalid formats)

12. **Performance baseline established**: Current bundle is ~457 KB gzipped (within 500 KB target). Lighthouse scores: Performance 75, Accessibility 90, Best Practices 100, SEO 91. Core Web Vitals show slow FCP (4.0s) and LCP (4.4s) due to large JS bundle (1,070 KB main chunk). Build time is 4.13s. See docs/architecture/PERFORMANCE_BASELINE.md for detailed analysis.

13. **Bundle optimization opportunities**:
    - Main bundle is 1,070 KB (needs code-splitting)
    - MUI components add ~300 KB (replace with Tailwind)
    - Export libraries (html-to-image, jspdf) add ~200 KB (lazy load)
    - Expected bundle reduction after Astro migration: ~30-40%

14. **Astro project initialized**: The `course-scheduler-astro/` directory contains Astro 5.17.x with React 19.x and Tailwind 4.x integrations. Build time is ~1.4s, significantly faster than the React/Vite build (4.13s). TypeScript strict mode is enabled via `extends: "astro/tsconfigs/strict"`. Base path `/CITUCourseBuilder/` configured for GitHub Pages deployment.

15. **React islands hydration strategy defined**: Each component has a specific hydration directive based on its interactivity needs:
    - `client:load`: RawDataInput, CourseTable, ConfirmDialog (immediate interactivity required)
    - `client:visible`: TimeFilter, TimetableView (lazy load when scrolled into view)
    - React runtime (~58.5 kB gzipped) only loads when islands are present
    - Each island is code-split for optimal caching
    - See docs/architecture/REACT_ISLANDS_HYDRATION.md for complete configuration

16. **TypeScript configuration in Astro**: The `astro/tsconfigs/strict` preset enables all required strict options (`strict: true`, `noImplicitAny`, `strictNullChecks`, `strictFunctionTypes`, etc.). Typecheck script is `astro check && tsc --noEmit` which runs both Astro-specific diagnostics and TypeScript compiler. The `@astrojs/check` package provides Astro file diagnostics. All `@types/*` packages are installed as dependencies (not devDependencies) in Astro projects.

17. **Tailwind v4 CSS-based configuration**: Tailwind v4 uses CSS-based configuration with `@theme` directive instead of JavaScript config files. The `@tailwindcss/vite` plugin is used (not `@astrojs/tailwind`). Theme switching uses CSS custom properties with `data-theme` and `data-palette` attributes on `document.documentElement`. The theme flash prevention script must be inline in `<head>` (using `is:inline`) to apply theme before page renders. The `@import` statement for Google Fonts must come before other CSS rules to avoid warnings. See `course-scheduler-astro/src/styles/global.css` for the complete theme configuration with 6 theme combinations (light/dark Ã— original/comfort/space palettes).

18. **Astro project structure with path aliases**: The `course-scheduler-astro/src/` directory follows a standard Astro + React islands architecture with directories for components (React islands), layouts (Astro layouts), pages (Astro pages), styles (global CSS), utils (preserved logic), hooks (custom React hooks), types (TypeScript definitions), and assets (static assets). TypeScript path aliases are configured in `tsconfig.json` with `baseUrl: "."` and `paths` mapping `@/*`, `@components/*`, `@layouts/*`, etc. to their respective directories for clean imports. A separate `tests/` directory exists at the project root for test files.

19. **Lint-staged configuration at monorepo root**: The root `package.json` contains lint-staged configuration for the entire project. File patterns cover `*.{js,jsx,ts,tsx}` and `*.astro` files running `eslint --fix`. The configuration works with husky (T2.2.2) for pre-commit hooks. ESLint must be installed at root level (T2.2.3) for the linting commands to execute successfully.

20. **Husky pre-commit and commit-msg hooks**: Husky v9.1.7 is configured at the monorepo root with two hooks:
    - `.husky/pre-commit`: Runs `bun run lint-staged` to lint staged files before commit
    - `.husky/commit-msg`: Validates conventional commits format (type[scope]: description)
    - Git hooks path is set via `git config core.hooksPath .husky`
    - The commit-msg hook allows merge commits, revert commits, and fixup/squash commits without validation
    - Conventional commit types: feat, fix, build, chore, ci, docs, style, refactor, perf, test

21. **ESLint flat config at monorepo root**: ESLint v10.0.0 is configured at the monorepo root with flat config (`eslint.config.js`). The configuration supports JavaScript (.js, .jsx), TypeScript (.ts, .tsx), and Astro (.astro) files. Key packages: `eslint`, `@eslint/js`, `eslint-plugin-astro`, `eslint-plugin-react`, `eslint-plugin-react-hooks`, `eslint-plugin-react-refresh`, `typescript-eslint`, `globals`. Preserved logic files (parseSchedule.js, parseRawData.js, generateIcs.js, convertToRawData.js) are explicitly ignored via the `ignores` property in the config. Nested ESLint configs (like the one that was in `course-scheduler-web/`) should be removed to avoid conflicts - the root config handles all files. Use `bun run lint` to check all files and `bun run lint:fix` to auto-fix issues.

22. **Prettier configuration at monorepo root**: Prettier v3.8.1 is configured at the monorepo root with `prettier-plugin-astro` v0.14.1 for Astro file support. Configuration is in `.prettierrc` with formatting rules: semicolons, single quotes, 2-space tabs, trailing commas (ES5), 100-char print width. The `.prettierignore` file excludes build artifacts (`dist/`, `.astro/`), lock files (`package-lock.json`), and generated files (`*.d.ts`, `*.mjs`). Lint-staged runs Prettier after ESLint on pre-commit for `*.{js,jsx,ts,tsx,astro,json,md,css}` files. Use `bun run format` to format all files and `bun run format:check` to verify formatting in CI.

23. **CI status checks in GitHub Actions**: The GitHub Actions workflow (`.github/workflows/deploy.yml`) includes four CI checks: lint (ESLint), typecheck (TypeScript), test (Vitest), and build (Astro). These checks run on every push to `main` branch. Branch protection rules must be manually configured in GitHub repository settings to require these checks to pass before merging. See `docs/BRANCH_PROTECTION.md` for manual setup instructions. The workflow fails fast - any failing step prevents deployment.

24. **TypeScript path alias conflict with @types**: The path alias `@types/*` configured in `tsconfig.json` conflicts with TypeScript's built-in `@types/*` package convention (used for DefinitelyTyped packages). This causes import errors like "Cannot import type declaration files." Solution: Use `@/types/*` instead of `@types/*` for local type imports. Example: `import type { DayCode } from '@/types/index'` instead of `import type { DayCode } from '@types/index'`.

## Protected Files

The following files are protected by the Ralph write-guardrail plugin and should not be directly modified by AI:

- `prd.json` - PRD plan file (update via Ralph workflow)
- `progress.txt` - Progress tracking (append via Ralph workflow)
- `.ralph-prompt.md` - Prompt template
- `AGENTS.md` - This file

## References

- Project Documentation: docs/architecture/ (state analysis, component graphs, algorithm docs)
- Architecture Decisions: docs/architecture/decisions/ (ADRs)
- ADR-001: Framework Migration Approach (Astro + React islands)
- ADR-002: UI Component Strategy (Custom Tailwind + Lucide icons)
- ADR-003: State Management Approach (React state via islands + localStorage)
- Architecture Analysis: docs/architecture/APP_STATE_ANALYSIS.md
- Component Graphs: docs/architecture/COMPONENT_DEPENDENCY_GRAPH.md
- Algorithm Documentation: docs/architecture/SCHEDULING_ALGORITHMS.md
- CSS Architecture: docs/architecture/CSS_ARCHITECTURE.md
- Test Coverage Baseline: docs/architecture/TEST_COVERAGE_BASELINE.md
- Performance Baseline: docs/architecture/PERFORMANCE_BASELINE.md
- TypeScript Interfaces: docs/architecture/types/index.ts
- React Islands Hydration: docs/architecture/REACT_ISLANDS_HYDRATION.md
- Branch Protection: docs/BRANCH_PROTECTION.md
- Usage Guide: https://github.com/MasuRii/CITUCourseBuilder/blob/main/UsageGuide.md
