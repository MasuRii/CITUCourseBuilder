#!/usr/bin/env sh
# Validate conventional commits format
# Format: type[optional scope]: description
# Types: feat, fix, build, chore, ci, docs, style, refactor, perf, test

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Regex for conventional commits
# - type (required): lowercase noun
# - scope (optional): in parentheses
# - optional ! for breaking change
# - colon followed by space
# - description (required): imperative mood, no trailing period
PATTERN='^(feat|fix|build|chore|ci|docs|style|refactor|perf|test)(\([a-zA-Z0-9_-]+\))?!?: .+'

# Allow merge commits, revert commits, and fixup/squash commits
if echo "$COMMIT_MSG" | grep -qE '^Merge (branch|remote-tracking branch)'; then
  exit 0
fi

if echo "$COMMIT_MSG" | grep -qE '^(fixup|squash)! '; then
  exit 0
fi

if echo "$COMMIT_MSG" | grep -qE '^Revert "'; then
  exit 0
fi

# Check if commit message matches conventional commits pattern
if ! echo "$COMMIT_MSG" | head -n 1 | grep -qE "$PATTERN"; then
  echo ""
  echo "‚ùå Commit message does not follow Conventional Commits format!"
  echo ""
  echo "Expected format: type[optional scope]: description"
  echo ""
  echo "Types: feat, fix, build, chore, ci, docs, style, refactor, perf, test"
  echo ""
  echo "Examples:"
  echo "  feat(auth): add password strength validation"
  echo "  fix: correct typo in installation guide"
  echo "  refactor(api)!: require API version header"
  echo ""
  echo "Your message:"
  echo "  $COMMIT_MSG"
  echo ""
  exit 1
fi

exit 0
